<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplikationsmästaren: Math Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'JetBrains Mono', monospace; 
            background-color: #f0f4f8;
            /* Rutat papper effekt */
            background-image: 
                linear-gradient(#cbd5e1 1px, transparent 1px),
                linear-gradient(90deg, #cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Dölj element (JS-logik) */
        .hidden { display: none !important; }

        /* Anpassad scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; }

        /* Kalkylator-knapp effekt */
        .calc-btn {
            transition: all 0.1s;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.8);
        }
        .calc-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.8);
        }
        .calc-btn.active {
            background-color: #2563eb !important; /* Blue-600 */
            color: white !important;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.8);
        }

        /* Input fokus utan glow, med skarp kant */
        input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 4px 4px 0px 0px #cbd5e1;
        }

        /* Flytande symboler animation */
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); opacity: 0.1; }
            50% { transform: translateY(-20px) rotate(10deg); opacity: 0.3; }
            100% { transform: translateY(0px) rotate(0deg); opacity: 0.1; }
        }
        .math-symbol {
            position: absolute;
            color: #1e293b;
            font-size: 3rem;
            animation: float 6s ease-in-out infinite;
            z-index: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col items-center justify-center relative overflow-hidden">

    <div class="math-symbol" style="top: 10%; left: 10%; animation-delay: 0s;">∑</div>
    <div class="math-symbol" style="top: 20%; right: 15%; animation-delay: 1s;">π</div>
    <div class="math-symbol" style="bottom: 15%; left: 20%; animation-delay: 2s;">√</div>
    <div class="math-symbol" style="bottom: 10%; right: 10%; animation-delay: 3s;">%</div>
    <div class="math-symbol" style="top: 50%; left: 5%; animation-delay: 4s;">÷</div>

    <div class="container relative z-10 w-full max-w-lg px-4">
        
        <div class="bg-white border-4 border-slate-800 shadow-[8px_8px_0px_0px_rgba(30,41,59,1)] p-8 text-center relative">
            
            <div class="absolute top-2 left-2 w-2 h-2 rounded-full bg-slate-300 border border-slate-500"></div>
            <div class="absolute top-2 right-2 w-2 h-2 rounded-full bg-slate-300 border border-slate-500"></div>
            <div class="absolute bottom-2 left-2 w-2 h-2 rounded-full bg-slate-300 border border-slate-500"></div>
            <div class="absolute bottom-2 right-2 w-2 h-2 rounded-full bg-slate-300 border border-slate-500"></div>

            <div id="start-screen">
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2 tracking-tighter">MULTIPLIKATION<span class="text-blue-600">.EXE</span></h1>
                <div class="h-1 w-24 bg-blue-600 mx-auto mb-6"></div>
                
                <p class="text-slate-500 font-bold mb-8 text-sm">> SYSTEM READY...</p>
                
                <div class="space-y-6">
                    <div class="text-left">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Användarnamn</label>
                        <input type="text" id="username" placeholder="Ange namn_" autocomplete="off" 
                               class="w-full bg-slate-100 border-2 border-slate-300 px-4 py-3 text-lg text-slate-800 font-bold placeholder-slate-400 transition-all">
                    </div>
                    
                    <div>
                        <p class="text-slate-800 text-sm font-bold mb-3 uppercase tracking-wide border-b-2 border-slate-200 inline-block pb-1">Konfiguration: Antal</p>
                        <div class="mode-selector flex justify-center gap-3">
                            <div class="calc-btn active cursor-pointer px-4 py-3 bg-white border-2 border-slate-800 font-bold hover:bg-slate-50" onclick="selectMode(25, this)">25</div>
                            <div class="calc-btn cursor-pointer px-4 py-3 bg-white border-2 border-slate-800 font-bold hover:bg-slate-50" onclick="selectMode(50, this)">50</div>
                            <div class="calc-btn cursor-pointer px-4 py-3 bg-white border-2 border-slate-800 font-bold hover:bg-slate-50" onclick="selectMode(100, this)">100</div>
                        </div>
                    </div>

                    <button class="calc-btn w-full bg-blue-600 hover:bg-blue-500 border-2 border-slate-900 text-white font-bold py-4 text-xl mt-4" onclick="startGame(false)">
                        [ STARTA BERÄKNING ]
                    </button>
                    
                    <button class="text-slate-400 hover:text-slate-800 text-xs mt-4 hover:underline" onclick="showHighscores()">
                        VIEW_HIGHSCORE_LOG.TXT
                    </button>
                </div>
            </div>

            <div id="game-screen" class="hidden">
                <div class="flex justify-between items-end mb-8 border-b-2 border-slate-200 pb-2">
                    <div class="flex flex-col text-left">
                        <span class="text-xs text-slate-400 font-bold uppercase">Progress</span>
                        <span id="counter-display" class="text-blue-600 font-bold text-xl">1 / 25</span>
                    </div>
                    <div class="flex flex-col text-right">
                        <span class="text-xs text-slate-400 font-bold uppercase">Timer</span>
                        <div class="timer text-orange-600 font-bold text-xl" id="timer-display">0.0 s</div>
                    </div>
                </div>
                
                <div class="bg-[#d1e7dd] border-4 border-slate-400 inner-shadow p-6 mb-8 rounded-sm">
                    <div class="question-box text-6xl font-bold text-slate-800 tracking-widest font-mono opacity-90" id="question">? x ?</div>
                </div>
                
                <input type="number" id="answer" placeholder="0" autocomplete="off" 
                       class="answer-input w-40 bg-white border-4 border-slate-800 p-3 text-center text-4xl font-bold text-slate-900 mb-2 focus:border-blue-600">
                
                <div id="feedback-msg" class="h-8 font-bold text-lg mb-6 uppercase tracking-wider"></div>
                
                <div class="w-full h-4 bg-slate-200 border-2 border-slate-800 relative">
                    <div class="progress-bar h-full bg-blue-600" id="progress" style="width: 0%"></div>
                    <div class="absolute top-0 bottom-0 left-1/4 w-0.5 bg-white/30"></div>
                    <div class="absolute top-0 bottom-0 left-2/4 w-0.5 bg-white/30"></div>
                    <div class="absolute top-0 bottom-0 left-3/4 w-0.5 bg-white/30"></div>
                </div>
            </div>

            <div id="result-screen" class="hidden">
                <div class="border-b-4 border-slate-800 mb-6 pb-4">
                    <h2 id="result-title" class="text-3xl font-extrabold text-slate-900 uppercase">Analys Klar</h2>
                    <p class="text-xs text-slate-400 font-mono">Process terminated successfully.</p>
                </div>
                
                <div class="stats-grid grid grid-cols-2 gap-4 mb-6 text-left">
                    <div class="stat-item bg-slate-50 p-3 border-2 border-slate-200">
                        <div class="text-xs text-slate-400 uppercase font-bold">Score</div>
                        <span class="stat-value text-2xl font-bold text-green-600" id="res-score"></span>
                    </div>
                    <div class="stat-item bg-slate-50 p-3 border-2 border-slate-200">
                        <div class="text-xs text-slate-400 uppercase font-bold">Total Time</div>
                        <span class="stat-value text-2xl font-bold text-blue-600" id="res-time"></span>
                    </div>
                    <div class="stat-item bg-slate-50 p-3 border-2 border-slate-200">
                        <div class="text-xs text-slate-400 uppercase font-bold">Avg/Calc</div>
                        <span class="stat-value text-xl font-bold text-slate-700" id="res-avg"></span>
                    </div>
                    <div class="stat-item bg-slate-50 p-3 border-2 border-slate-200">
                        <div class="text-xs text-slate-400 uppercase font-bold">Streak</div>
                        <span class="stat-value text-xl font-bold text-orange-500" id="res-streak"></span>
                    </div>
                </div>

                <div id="analysis-container" class="analysis-box hidden bg-yellow-50 border-2 border-dashed border-yellow-400 text-left p-4 mb-6">
                    <strong class="text-yellow-700 block mb-2 text-xs uppercase tracking-wide">⚠️ Optimering Krävs:</strong>
                    <ul id="slow-list" class="text-slate-700 text-sm space-y-1 list-decimal pl-5 font-mono"></ul>
                </div>

                <button id="retry-mistakes-btn" class="calc-btn hidden w-full mb-3 bg-orange-500 hover:bg-orange-400 border-2 border-slate-900 text-white font-bold py-3 uppercase tracking-wide" onclick="startRepetition()">
                    Repetera Fel
                </button>
                
                <button class="calc-btn w-full bg-slate-800 hover:bg-slate-700 border-2 border-black text-white font-bold py-3 uppercase tracking-wide mb-4" onclick="resetApp()">
                    Starta Om
                </button>
                
                <button class="text-slate-400 hover:text-slate-800 text-xs underline" onclick="showHighscores()">
                    Visa Topplista
                </button>
            </div>

            <div id="highscore-screen" class="hidden">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center justify-center gap-2 uppercase tracking-wide border-b-2 border-slate-200 pb-4">
                    Databas: Topplista
                </h2>
                
                <div class="tab-container flex justify-center gap-2 mb-6">
                    <button class="tab-btn active px-3 py-1 border-b-4 border-blue-600 font-bold text-slate-800" onclick="renderHighscoreTable(25, this)">25</button>
                    <button class="tab-btn px-3 py-1 border-b-4 border-transparent text-slate-400 hover:text-slate-600" onclick="renderHighscoreTable(50, this)">50</button>
                    <button class="tab-btn px-3 py-1 border-b-4 border-transparent text-slate-400 hover:text-slate-600" onclick="renderHighscoreTable(100, this)">100</button>
                </div>

                <div class="border-2 border-slate-300 mb-6 bg-slate-50">
                    <table id="highscore-table" class="w-full text-sm text-left font-mono">
                        <thead class="bg-slate-200 text-slate-600 uppercase text-xs">
                            <tr>
                                <th class="px-4 py-2 border-r border-slate-300">#</th>
                                <th class="px-4 py-2 border-r border-slate-300">ID</th>
                                <th class="px-4 py-2 border-r border-slate-300">Tid</th>
                                <th class="px-4 py-2">Datum</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-300 text-slate-700">
                            </tbody>
                    </table>
                </div>
                
                <button class="calc-btn px-8 py-2 bg-white border-2 border-slate-800 hover:bg-slate-100 text-slate-800 font-bold" onclick="resetApp()">
                    << TILLBAKA
                </button>
            </div>
        </div>
    </div>

<script>
    // --- Configuration & State ---
    const CONFIG = {
        slowThreshold: 5000, 
        penaltyTime: 0 
    };

    let state = {
        questionCount: 25,
        isRepetitionMode: false,
        questions: [],
        currentIndex: 0,
        startTime: 0,
        qStartTime: 0,
        timerInterval: null,
        results: [],
        mistakesToRepeat: [],
        currentHighscoreTab: 25
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('answer').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') checkAnswer();
        });
        
        const storedName = localStorage.getItem('mm_username');
        if(storedName) document.getElementById('username').value = storedName;
    });

    function selectMode(count, btn) {
        state.questionCount = count;
        // Logic for styling active button
        document.querySelectorAll('.mode-btn, .calc-btn').forEach(b => {
            if(b.parentNode.classList.contains('mode-selector')) b.classList.remove('active');
        });
        btn.classList.add('active');
    }

    // --- Game Logic ---

    function generateQuestions(count) {
        let qs = [];
        for(let i=0; i<count; i++) {
            qs.push({
                a: Math.floor(Math.random() * 10) + 1,
                b: Math.floor(Math.random() * 10) + 1
            });
        }
        return qs;
    }

    function startGame(isRepetition) {
        const username = document.getElementById('username').value.trim();
        if (!username) { alert("ERROR: Username Required"); return; }
        localStorage.setItem('mm_username', username);

        state.isRepetitionMode = isRepetition;
        state.results = []; 
        state.currentIndex = 0;

        if (isRepetition) {
            state.questions = [...state.mistakesToRepeat];
            state.questions.sort(() => Math.random() - 0.5);
        } else {
            state.questions = generateQuestions(state.questionCount);
            state.mistakesToRepeat = []; 
        }

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('highscore-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');

        state.startTime = Date.now();
        startGlobalTimer();
        showNextQuestion();
    }

    function showNextQuestion() {
        if (state.currentIndex >= state.questions.length) {
            endGame();
            return;
        }

        const q = state.questions[state.currentIndex];
        document.getElementById('question').innerText = `${q.a} × ${q.b}`;
        document.getElementById('counter-display').innerText = `${state.currentIndex + 1} / ${state.questions.length}`;
        
        const input = document.getElementById('answer');
        input.value = '';
        input.focus();
        document.getElementById('feedback-msg').innerText = '';

        const pct = (state.currentIndex / state.questions.length) * 100;
        document.getElementById('progress').style.width = pct + '%';

        state.qStartTime = Date.now();
    }

    function checkAnswer() {
        const input = document.getElementById('answer');
        const val = parseInt(input.value);
        if (isNaN(val)) return;

        const q = state.questions[state.currentIndex];
        const correctVal = q.a * q.b;
        const isCorrect = val === correctVal;
        const timeTaken = Date.now() - state.qStartTime;

        state.results.push({
            a: q.a,
            b: q.b,
            userAnswer: val,
            correct: isCorrect,
            time: timeTaken
        });

        const fb = document.getElementById('feedback-msg');
        if (isCorrect) {
            fb.innerText = "CORRECT";
            fb.className = "h-8 font-bold text-lg mb-6 text-green-600 uppercase tracking-wider"; 
            
            state.currentIndex++;
            setTimeout(showNextQuestion, 150); 
        } else {
            fb.innerText = `ERROR: ${q.a}×${q.b}=${correctVal}`;
            fb.className = "h-8 font-bold text-lg mb-6 text-red-600 uppercase tracking-wider"; 
            
            setTimeout(() => {
                state.currentIndex++;
                showNextQuestion();
            }, 1500);
        }
    }

    // --- Timer ---
    function startGlobalTimer() {
        if(state.timerInterval) clearInterval(state.timerInterval);
        state.timerInterval = setInterval(() => {
            const delta = (Date.now() - state.startTime) / 1000;
            document.getElementById('timer-display').innerText = delta.toFixed(1) + " s";
        }, 100);
    }

    // --- End Game & Analysis ---

    function endGame() {
        clearInterval(state.timerInterval);
        const totalTime = Date.now() - state.startTime;
        const totalSeconds = (totalTime / 1000).toFixed(2);
        
        const correctCount = state.results.filter(r => r.correct).length;
        const avgTime = (totalTime / state.results.length / 1000).toFixed(2);

        let maxStreak = 0;
        let currentStreak = 0;
        state.results.forEach(r => {
            if(r.correct) {
                currentStreak++;
                if(currentStreak > maxStreak) maxStreak = currentStreak;
            } else {
                currentStreak = 0;
            }
        });

        let slowOrWrong = state.results.filter(r => !r.correct || r.time > CONFIG.slowThreshold);
        
        let uniqueMistakes = [];
        const seen = new Set();
        slowOrWrong.forEach(r => {
            const key = `${r.a}x${r.b}`;
            if(!seen.has(key)) {
                seen.add(key);
                uniqueMistakes.push({a: r.a, b: r.b});
            }
        });

        state.mistakesToRepeat = uniqueMistakes;

        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('progress').style.width = "100%";

        document.getElementById('res-score').innerText = `${correctCount} / ${state.results.length}`;
        document.getElementById('res-time').innerText = totalSeconds + " s";
        document.getElementById('res-avg').innerText = avgTime + " s";
        document.getElementById('res-streak').innerText = maxStreak;

        const analysisBox = document.getElementById('analysis-container');
        const retryBtn = document.getElementById('retry-mistakes-btn');
        const slowList = document.getElementById('slow-list');
        slowList.innerHTML = '';

        if (slowOrWrong.length > 0) {
            analysisBox.classList.remove('hidden');
            retryBtn.classList.remove('hidden');
            
            slowOrWrong.sort((a,b) => b.time - a.time);
            
            slowOrWrong.slice(0, 5).forEach(item => {
                const reason = !item.correct ? "WRONG" : `${(item.time/1000).toFixed(1)}s`;
                const li = document.createElement('li');
                li.innerHTML = `<b>${item.a} × ${item.b}</b> <span class="text-red-500 font-bold">[${reason}]</span>`;
                slowList.appendChild(li);
            });
            
            if(slowOrWrong.length > 5) {
                const li = document.createElement('li');
                li.innerText = `...and ${slowOrWrong.length - 5} more.`;
                slowList.appendChild(li);
            }
            
            document.getElementById('result-title').innerText = "OPTIMERING KRÄVS";
            document.getElementById('result-title').className = "text-3xl font-extrabold text-orange-600 uppercase";
        } else {
            analysisBox.classList.add('hidden');
            retryBtn.classList.add('hidden');
            document.getElementById('result-title').innerText = "PERFEKT RESULTAT";
            document.getElementById('result-title').className = "text-3xl font-extrabold text-green-600 uppercase";
        }

        if (!state.isRepetitionMode && correctCount === state.results.length) {
            saveHighscore(state.questionCount, totalSeconds);
        }
    }

    function startRepetition() {
        startGame(true); 
    }

    function resetApp() {
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('highscore-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
    }

    // --- Highscore System ---

    function saveHighscore(category, timeSeconds) {
        const username = document.getElementById('username').value;
        const today = new Date().toISOString().split('T')[0];
        
        let db = JSON.parse(localStorage.getItem('mm_highscores_v2')) || { "25": [], "50": [], "100": [] };
        
        db[category].push({ name: username, time: parseFloat(timeSeconds), date: today });
        
        db[category].sort((a, b) => a.time - b.time);
        db[category] = db[category].slice(0, 10);
        
        localStorage.setItem('mm_highscores_v2', JSON.stringify(db));
    }

    function showHighscores() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('highscore-screen').classList.remove('hidden');
        
        const tabToOpen = state.questionCount || 25;
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(b => {
            if(b.innerText.includes(tabToOpen)) renderHighscoreTable(tabToOpen, b);
        });
    }

    function renderHighscoreTable(category, btnElement) {
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            b.classList.remove('border-blue-600');
            b.classList.remove('text-slate-800');
            b.classList.add('border-transparent');
            b.classList.add('text-slate-400');
        });
        
        if(btnElement) {
            btnElement.classList.remove('border-transparent');
            btnElement.classList.remove('text-slate-400');
            btnElement.classList.add('active');
            btnElement.classList.add('border-blue-600');
            btnElement.classList.add('text-slate-800');
        }

        state.currentHighscoreTab = category;
        
        const db = JSON.parse(localStorage.getItem('mm_highscores_v2')) || { "25": [], "50": [], "100": [] };
        const list = db[category] || [];
        const tbody = document.querySelector('#highscore-table tbody');
        
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-slate-400">DATABASE_EMPTY</td></tr>';
            return;
        }

        tbody.innerHTML = list.map((s, i) => `
            <tr class="${i===0 ? 'bg-yellow-100 font-bold' : 'hover:bg-slate-100'}">
                <td class="px-4 py-2 border-r border-slate-300">${i+1}</td>
                <td class="px-4 py-2 border-r border-slate-300">${s.name}</td>
                <td class="px-4 py-2 border-r border-slate-300 font-bold">${s.time.toFixed(2)} s</td>
                <td class="px-4 py-2 text-xs text-slate-500">${s.date}</td>
            </tr>
        `).join('');
    }
</script>
</body>
</html>
